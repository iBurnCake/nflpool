<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Console</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#eee;background:#121212}
    .wrap{max-width:760px;margin:40px auto;padding:24px;background:#1e1e1e;border:1px solid #333;border-radius:12px}
    h1{margin:0 0 14px;color:#FFD700}
    h3{margin-top:24px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0}
    label{opacity:.9}
    button{background:#3B7EED;color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    button:hover{background:#1F5B99}
    select,input{background:#0f0f0f;color:#fff;border:1px solid #333;border-radius:8px;padding:8px}
    .pill{display:inline-block;border:1px solid #FFD700;color:#FFD700;border-radius:24px;padding:6px 10px;margin-left:8px}
    .pill.gray{border-color:#666;color:#bbb}
    pre{background:#0f0f0f;border:1px solid #333;border-radius:8px;padding:10px;white-space:pre-wrap}
    a.btn{display:inline-block;background:#444;border:1px solid #666;border-radius:8px;padding:8px 12px;color:#fff;text-decoration:none}
    a.btn:hover{background:#333}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-weight:700;text-align:left;opacity:.9}
    .table td,.table th{padding:8px 10px;background:#151515;border:1px solid #2a2a2a}
    .table tr td:first-child,.table tr th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    .table tr td:last-child,.table tr th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
    .muted{opacity:.8}
    .ok{color:#7EE787}
    .warn{color:#FFD700}
    .bad{color:#FF6B6B}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin Console</h1>

    <div id="adminOnly" style="display:none;">
      <div class="row">
        <a class="btn" href="index.html">← Back to Home</a>
        <span id="who" class="pill">Checking auth…</span>
      </div>

      <h3>Week / Lock</h3>
      <div class="row">
        <label>Current week:</label>
        <select id="weekSel"></select>
        <button id="saveWeekBtn">Set Current Week</button>
        <span id="weekInfo" class="pill"></span>
      </div>

      <div class="row">
        <label>Global Picks Lock:</label>
        <button id="toggleLockBtn">Toggle</button>
        <span id="lockInfo" class="pill"></span>
      </div>

      <h3>Finalize Winners</h3>
      <div class="row">
        <button id="finalizeBtn">Finalize Winners For Selected Week</button>
      </div>

      <h3>Money Pool Entry Fee</h3>
      <div class="row">
        <button id="chargePoolBtn">Charge $5 to Current Pool Members</button>
        <span id="chargeInfo" class="pill gray small">Not charged</span>
      </div>
      <div class="row small muted">
        <span>
          Charges each <code>subscriberPools/&lt;week&gt;/members</code> user: <code>stats.totalStaked += 5</code> and <code>stats.totalWon -= 5</code>.
          Idempotent via <code>users/&lt;uid&gt;/stakesByWeek/&lt;week&gt;</code>.
        </span>
      </div>

      <h3>Access Requests</h3>
      <div class="row small muted">
        <span>Approve adds <code>allowlist/&lt;uid&gt;/approved: true</code>. Revoking sets it to <code>false</code>.</span>
      </div>
      <div class="row">
        <button id="refreshRequestsBtn">Refresh List</button>
        <span id="reqCount" class="pill gray">—</span>
      </div>

      <table class="table" id="reqTable" aria-label="Access Requests">
        <thead>
          <tr>
            <th>Display Name</th>
            <th>Email</th>
            <th class="small">UID</th>
            <th>Status</th>
            <th>Approved?</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reqTbody">
          <tr><td colspan="6" class="muted">Loading…</td></tr>
        </tbody>
      </table>

      <h3>Result</h3>
      <pre id="out">Waiting…</pre>
    </div>

    <div id="notAdmin" style="display:none;">
      <p>You must be signed in as admin to view this page.</p>
      <a class="btn" href="index.html">Back to Home</a>
    </div>
  </div>

  <script type="module">
    import { auth, onAuthStateChanged, db, ref, get, update } from './js/firebaseConfig.js';
    import { finalizeWeekOnce } from './js/winners.js';

    const ADMIN_UID = 'fqG1Oo9ZozX2Sa6mipdnYZI4ntb2';
    const ENTRY_FEE = 5;

    const out = (m) => document.getElementById('out').textContent =
      (typeof m === 'string') ? m : JSON.stringify(m, null, 2);

    const toNum = (x) => (typeof x === 'number' ? x : Number(x) || 0);

    async function listWeeks() {
      const opts = new Set();

      const cur = await get(ref(db, 'settings/currentWeek'));
      if (cur.exists()) opts.add(cur.val());

      const w = await get(ref(db, 'winners'));
      if (w.exists()) Object.keys(w.val() || {}).forEach(k => opts.add(k));

      const s = await get(ref(db, 'scoreboards'));
      if (s.exists()) Object.keys(s.val() || {}).forEach(k => opts.add(k));

      return [...opts].sort((a,b) => {
        const na = parseInt((/week(\d+)/i.exec(a) || [0,0])[1], 10);
        const nb = parseInt((/week(\d+)/i.exec(b) || [0,0])[1], 10);
        return (na - nb) || a.localeCompare(b);
      });
    }

    async function fillUI() {
      const weeks = await listWeeks();
      const sel = document.getElementById('weekSel');
      sel.innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('') || '<option value="week1">week1</option>';

      const cur = await get(ref(db, 'settings/currentWeek'));
      if (cur.exists() && weeks.includes(cur.val())) sel.value = cur.val();

      const wk = sel.value;
      const labelSnap = await get(ref(db, `winners/${wk}/label`));
      document.getElementById('weekInfo').textContent = labelSnap.exists() ? labelSnap.val() : wk;

      let locked = false;
      try {
        const lockSnap = await get(ref(db, 'settings/lockAllPicks'));
        if (lockSnap.exists()) {
          locked = !!lockSnap.val();
        } else {
          const legacy = await get(ref(db, 'settings/picksLocked'));
          if (legacy.exists()) locked = !!legacy.val();
        }
      } catch (e) {
        console.warn('fillUI lock read error:', e);
      }
      document.getElementById('lockInfo').textContent = `lockAllPicks = ${locked}`;
    }

    async function toggleLock() {
      try {
        const lockRef = ref(db, 'settings/lockAllPicks');
        const snap = await get(lockRef);
        const current = snap.exists() ? !!snap.val() : false;
        const next = !current;

        await update(ref(db, 'settings'), { lockAllPicks: next, picksLocked: next });
        document.getElementById('lockInfo').textContent = `lockAllPicks = ${next}`;
      } catch (e) {
        console.error('toggleLock error:', e);
        document.getElementById('lockInfo').textContent = 'lockAllPicks = ? (error)';
      }
    }

    async function saveCurrentWeek() {
      const wk = document.getElementById('weekSel').value;
      await update(ref(db, 'settings'), { currentWeek: wk });
      const labelSnap = await get(ref(db, `winners/${wk}/label`));
      document.getElementById('weekInfo').textContent = labelSnap.exists() ? labelSnap.val() : wk;
    }

    async function finalizeNow() {
      const wk = document.getElementById('weekSel').value;
      out(`Finalizing ${wk}…`);
      try {
        const res = await finalizeWeekOnce(wk);
        out({ week: wk, ...res });
      } catch (e) {
        out(`Error: ${e?.message || e}`);
      }
    }

    async function chargePoolEntry() {
      const wk = document.getElementById('weekSel').value;
      document.getElementById('chargeInfo').textContent = 'Charging…';
      out(`Charging $${ENTRY_FEE} to pool members for ${wk}…`);

      const memSnap = await get(ref(db, `subscriberPools/${wk}/members`));
      if (!memSnap.exists()) {
        document.getElementById('chargeInfo').textContent = 'No pool members';
        out('No pool members for this week.');
        return;
      }
      const members = memSnap.val() || {};
      const uids = Object.entries(members).filter(([,v]) => !!v).map(([uid]) => uid);

      if (uids.length === 0) {
        document.getElementById('chargeInfo').textContent = 'No pool members';
        out('No pool members flagged true.');
        return;
      }

      const updates = {};
      const charged = [];
      const skipped = [];

      for (const uid of uids) {
        const flagRef = ref(db, `users/${uid}/stakesByWeek/${wk}`);
        const flag = await get(flagRef);
        if (flag.exists()) { skipped.push(uid); continue; }

        const stSnap = await get(ref(db, `users/${uid}/stats/totalStaked`));
        const wonSnap = await get(ref(db, `users/${uid}/stats/totalWon`));
        const curSt = toNum(stSnap.exists() ? stSnap.val() : 0);
        const curWon = toNum(wonSnap.exists() ? wonSnap.val() : 0);

        updates[`users/${uid}/stats/totalStaked`] = curSt + ENTRY_FEE;
        updates[`users/${uid}/stats/totalWon`]   = curWon - ENTRY_FEE;
        updates[`users/${uid}/stakesByWeek/${wk}`] = ENTRY_FEE;

        charged.push(uid);
      }

      updates[`winners/${wk}/entryCharges/chargedAt`] = Date.now();
      updates[`winners/${wk}/entryCharges/chargedUids`] = charged;

      await update(ref(db), updates);

      const msg = `Charged: ${charged.length}, Skipped (already charged): ${skipped.length}`;
      document.getElementById('chargeInfo').textContent = msg;
      out({ week: wk, chargedCount: charged.length, skippedCount: skipped.length, charged });
    }

    function row(html){ const tr=document.createElement('tr'); tr.innerHTML=html; return tr; }

    async function isApproved(uid) {
      const s = await get(ref(db, `allowlist/${uid}/approved`));
      return s.exists() && s.val() === true;
    }

    async function approve(uid) {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        return out('Not authorized.');
      }
      const now = Date.now();
      await update(ref(db), {
        [`allowlist/${uid}`]: { approved: true, approvedAt: now, approvedBy: ADMIN_UID }
      });
      await loadRequests();
    }

    async function revoke(uid) {
      if (!auth.currentUser || auth.currentUser.uid !== ADMIN_UID) {
        return out('Not authorized.');
      }
      const now = Date.now();
      await update(ref(db), {
        [`allowlist/${uid}`]: { approved: false, approvedAt: now, approvedBy: ADMIN_UID }
      });
      await loadRequests();
    }

    async function loadRequests() {
      const tbody = document.getElementById('reqTbody');
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading…</td></tr>';

      const snap = await get(ref(db, 'accessRequests'));
      const data = snap.exists() ? (snap.val() || {}) : {};
      const entries = Object.entries(data).map(([uid, v]) => ({ uid, ...(v || {}) }));

      entries.sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));

      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No requests yet.</td></tr>';
        document.getElementById('reqCount').textContent = '0 requests';
        return;
      }

      const rows = await Promise.all(entries.map(async (e) => {
        const approved = await isApproved(e.uid);
        const status = e.status || 'pending';
        const name   = e.displayName || '—';
        const email  = e.email || '—';
        const uid    = e.uid;
        const approvedCell = approved ? '<span class="ok">Yes</span>' : '<span class="bad">No</span>';

        return row(`
          <td>${name}</td>
          <td>${email}</td>
          <td class="small muted">${uid}</td>
          <td class="small">${status}</td>
          <td>${approvedCell}</td>
          <td class="controls">
            <button data-approve="${uid}">Approve</button>
            <button data-revoke="${uid}" style="background:#444">Revoke</button>
          </td>
        `);
      }));

      tbody.innerHTML = '';
      rows.forEach(tr => tbody.appendChild(tr));
      document.getElementById('reqCount').textContent = `${entries.length} request${entries.length===1?'':'s'}`;

      tbody.querySelectorAll('[data-approve]').forEach(btn => {
        btn.addEventListener('click', (e) => approve(e.currentTarget.getAttribute('data-approve')));
      });
      tbody.querySelectorAll('[data-revoke]').forEach(btn => {
        btn.addEventListener('click', (e) => revoke(e.currentTarget.getAttribute('data-revoke')));
      });
    }

    onAuthStateChanged(auth, async (user) => {
      const adminOnly = document.getElementById('adminOnly');
      const notAdmin  = document.getElementById('notAdmin');
      const who = document.getElementById('who');

      if (!user || user.uid !== ADMIN_UID) {
        adminOnly.style.display = 'none';
        notAdmin.style.display  = 'block';
        return;
      }

      who.textContent = `Signed in as admin (${user.email || user.uid})`;
      adminOnly.style.display = 'block';
      notAdmin.style.display  = 'none';

      await fillUI();
      await loadRequests();

      document.getElementById('toggleLockBtn').onclick = toggleLock;
      document.getElementById('saveWeekBtn').onclick = saveCurrentWeek;
      document.getElementById('finalizeBtn').onclick = finalizeNow;
      document.getElementById('weekSel').onchange = fillUI;
      document.getElementById('refreshRequestsBtn').onclick = loadRequests;
      document.getElementById('chargePoolBtn').onclick = chargePoolEntry;
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }
  </script>
</body>
</html>
